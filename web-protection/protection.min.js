/*!
 * Munetios Web Protection
 * https://api.munetios.com/web-protection/
 *
 * ¬© 2025 Munetios
 * Licensed under the MIT License
 *
 * Attribution required. See README for details.
 */

(function () {
  'use strict';

  const CONFIG = Object.assign(
    { mode: 'strict', warnYouTube: true },
    window.MunetiosProtection || {}
  );

  if (CONFIG.mode === 'off') return;

  /* ================================
     Blocklists
  ================================= */
  const MALICIOUS_DOMAINS = [
    'get-free-minecoins.xyz',
    'free-crypto-reward.xyz',
    'wallet-verify.net',
    'polyfill.io',
    'coinhive.com',
    'cryptoloot.pro',
    'fakecdn.io',
    'malwarecdn.net'
  ];

  const TRACKER_DOMAINS = [
    'doubleclick.net',
    'google-analytics.com',
    'googletagmanager.com',
    'googleadservices.com',
    'googlesyndication.com',
    'scorecardresearch.com',
    'quantcast.com',
    'mixpanel.com',
    'hotjar.com',
    'segment.com',
    'optimizely.com',
    'newrelic.com'
  ];

  const ACTIVE_BLOCKLIST =
    CONFIG.mode === 'strict'
      ? MALICIOUS_DOMAINS.concat(TRACKER_DOMAINS)
      : MALICIOUS_DOMAINS;

  /* ================================
     Helpers
  ================================= */
  function getIframeUrl(iframe) {
    return iframe.getAttribute('src') || iframe.getAttribute('data-src') || '';
  }

  function isYouTubeUrl(url) {
    try {
      const h = new URL(url, location.href).hostname.toLowerCase();
      return (
        h.includes('youtube.com') ||
        h.includes('youtube-nocookie.com') ||
        h === 'youtu.be'
      );
    } catch {
      return false;
    }
  }

  function embedToWatchUrl(embedUrl) {
    try {
      const u = new URL(embedUrl, location.href);
      const id =
        u.pathname.includes('/embed/')
          ? u.pathname.split('/embed/')[1].split('?')[0]
          : null;
      return id ? `https://www.youtube.com/watch?v=${id}` : embedUrl;
    } catch {
      return embedUrl;
    }
  }

  function isBlockedUrl(url) {
    try {
      const host = new URL(url, location.href).hostname.toLowerCase();
      return ACTIVE_BLOCKLIST.some(d => host === d || host.endsWith('.' + d));
    } catch {
      return false;
    }
  }

  function softBlock(el, reason) {
    el.remove();
    console.warn('[Munetios Web Protection]', reason);
  }

  /* ================================
     YouTube Privacy Warning (TEXT KEPT)
  ================================= */
  function replaceYouTubeIframe(iframe) {
    if (!CONFIG.warnYouTube || iframe.dataset.munetiosHandled) return;

    const embedSrc = getIframeUrl(iframe);
    if (!embedSrc || !isYouTubeUrl(embedSrc)) return;

    iframe.dataset.munetiosHandled = '1';
    iframe.dataset.munetiosSrc = embedSrc;

    const watchUrl = embedToWatchUrl(embedSrc);

    const box = document.createElement('div');
    box.className = 'munetios-youtube-warning liquid-glass blur-sm';
    box.setAttribute('role', 'region');

    // ‚¨áÔ∏è MESSAGE IS UNCHANGED ‚¨áÔ∏è
    box.innerHTML = `
      <div style="padding:16px;text-align:center;">
        <p style="margin-bottom:12px;">
          üîê <strong>YouTube video Privacy Warning</strong><br>
          Loading this video may causes tracking or fingerprinting.
        </p>
        <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
          <button class="munetios-watch-here" style="
                background:
    linear-gradient(
      to bottom,
      rgba(255,255,255,0.16) 0%,
      rgba(255,255,255,0.06) 22%,
      rgba(255,255,255,0.04) 50%,
      rgba(255,255,255,0.06) 78%,
      rgba(255,255,255,0.14) 100%
    );
    box-shadow: 0 8px 32px 0 rgba( 31, 38, 135, 0.37 );
    backdrop-filter: blur( 1.75px )  saturate(180%) brightness(105%) contrast(100%);
    -webkit-backdrop-filter: blur( 1.75px )  saturate(200%) brightness(125%) contrast(100%);
    border-radius: 50px;
    border: 1px solid rgba(255, 255, 255, 0.18);
    padding: 10px 20px;
    color: #fff;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: inherit;
          ">‚ñ∂ Watch here</button>
          <a href="${watchUrl}" style="
                background:
    linear-gradient(
      to bottom,
        rgba(255,255,255,0.16) 0%,
        rgba(255,255,255,0.06) 22%,
        rgba(255,255,255,0.04) 50%,
        rgba(255,255,255,0.06) 78%,
        rgba(255,255,255,0.14) 100%
    );
    box-shadow: 0 8px 32px 0 rgba( 31, 38, 135, 0.37 );
    backdrop-filter: blur( 1.75px )  saturate(180%) brightness(105%) contrast(100%);
    -webkit-backdrop-filter: blur( 1.75px )  saturate(200%) brightness(125%) contrast(100%);
    border-radius: 50px;
    border: 1px solid rgba(255, 255, 255, 0.18);
    padding: 10px 20px;
    color: #fff;
    font-size: 14px;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: inherit;
    
          " target="_blank" rel="noopener noreferrer">
            üîó Watch on YouTube
          </a>
        </div>
      </div>
    `;

    box.querySelector('.munetios-watch-here').onclick = () => {
      iframe.setAttribute('src', iframe.dataset.munetiosSrc);
      box.replaceWith(iframe);
    };

    iframe.replaceWith(box);
  }

  /* ================================
     Initial Scan (ALL IFRAMES)
  ================================= */
  document.querySelectorAll('iframe').forEach(replaceYouTubeIframe);

  /* ================================
     MutationObserver (ROBUST)
  ================================= */
  new MutationObserver(mutations => {
    for (const m of mutations) {
      if (m.type === 'childList') {
        m.addedNodes.forEach(n => {
          if (n instanceof HTMLIFrameElement) {
            replaceYouTubeIframe(n);
          }
        });
      }

      if (m.type === 'attributes' && m.target instanceof HTMLIFrameElement) {
        replaceYouTubeIframe(m.target);
      }
    }
  }).observe(document.documentElement, {
    childList: true,
    subtree: true,
    attributes: true,
    attributeFilter: ['src', 'data-src']
  });

})();
